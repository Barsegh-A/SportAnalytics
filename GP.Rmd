---
output:
  html_document: default
  pdf_document: default
title: "Group 4"
author: "Aram Sargsyan, Ashot Janibekyan, Barsegh Atanyan, Sarin Sulahian"
# toc: yes 
# toc_depth: '3'
runtime: shiny
---

```{r setup, include=F}
knitr::opts_chunk$set(include=F, error=F, warning=F)
```

```{r}
libs<-c("caret","tidyr", "ggplot2", "knitr", "dplyr", "purrr", "plotly", "MASS", "BradleyTerry2", "devtools", "reldist", "shiny")
#load libs, install missing libs
load_libraries<-function(libs){
  new_libs <- libs[!(libs %in% installed.packages()[,"Package"])]
  if(length(new_libs)>0) {install.packages(new_libs)}
  lapply(libs, library, character.only = TRUE)
} 
load_libraries(libs)
install_github("HABET/CSE270")
library("SportsAnalytics270")

```

```{r}

addData <- function(country, league, startYear, endYear){
  combined <- data.frame()
  for(y in startYear:endYear){
    path <- paste0('data/', league, '/', league, y, '.csv')
    data <- read.csv(path)  
    data <- data %>% dplyr::select(HomeTeam, AwayTeam, FTHG, FTAG, FTR) %>% 
      rename(HOMETEAM = HomeTeam, AWAYTEAM = AwayTeam) %>% 
      mutate(SEASON = y, COUNTRY = country, LEAGUE = league, FTSC = paste0(FTHG, "-", FTAG), FTTG = FTHG + FTAG)
    
    combined <- rbind(combined, data)  
  }
  
  return(combined)
}

```


```{r}
data <- f_data_sm %>% dplyr::select(-c("H", "D", "A", "DATE")) 

championship <- addData("England", "Championship", 2005, 2020)
data <- rbind(data, championship)

bundesliga2 <- addData("Germany", "Bundesliga2", 1994, 2020)
data <- rbind(data, bundesliga2)

serieB <- addData("Italy", "SerieB", 1998, 2018)
data <- rbind(data, serieB)

segunda <- addData("Spain", "Segunda", 1997, 2020)
data <- rbind(data, segunda)

ligue2 <- addData("France", "Ligue2", 1997, 2020)
data <- rbind(data, ligue2)

data <- data %>% drop_na()

```



# Objective

```{r}

f_long <- data %>%
  dplyr::select(SEASON, COUNTRY, LEAGUE, HOMETEAM,AWAYTEAM,FTSC) %>%
  gather(key='flag', value = 'Team',-c(SEASON, COUNTRY, LEAGUE, FTSC)) %>%
  separate(FTSC, into = c('g1','g2'),sep = '-') %>%
  mutate(scored=ifelse(flag=='HOMETEAM',as.numeric(g1),as.numeric(g2)),
         conceded=ifelse(flag=='HOMETEAM',as.numeric(g2),as.numeric(g1)),
        WL=ifelse(scored>conceded,'W',ifelse(scored<conceded,"L",'D')),
        Points=ifelse(scored>conceded,3,ifelse(scored<conceded,0,1))) %>%
    dplyr::select(-c(g1,g2))


f <- f_long %>%
  group_by(SEASON, COUNTRY, LEAGUE, Team, WL) %>%
  summarise(Total_Points = sum(Points), Matches = n(), scored = sum(scored),
            conceded = sum(conceded)) %>%
  group_by(SEASON, COUNTRY, LEAGUE) %>%
  spread(WL,Matches) %>%
  group_by(SEASON, COUNTRY, LEAGUE, Team) %>%
  summarise(Scored=sum(scored), Conceded=sum(conceded),W=sum(W,na.rm = TRUE),
            D=sum(D,na.rm = TRUE),L=sum(L,na.rm = TRUE),Total_Points=sum(Total_Points)) %>%
  mutate(Position = dense_rank(desc(rank(Total_Points,ties.method = "first"))),
         Matches=D+L+W)%>%
  arrange(Position)

# f
```


# Combined Measure of Home Team Advantage

```{r}
df <- data %>% dplyr::select(SEASON, COUNTRY, LEAGUE, HOMETEAM, AWAYTEAM, FTHG, FTAG) %>%
  mutate(HW = 1)
df2 <- df %>% mutate(team1 = AWAYTEAM, team2 = HOMETEAM, HW = 0) %>% dplyr::select(SEASON, COUNTRY, LEAGUE, team1, team2, FTHG, FTAG, HW)
df <-  df %>% rename(team1 = HOMETEAM , team2 = AWAYTEAM)

df4 <- left_join(df, df2, by=c("SEASON", "COUNTRY", "LEAGUE", "team1", "team2"))
# head(df4)

```
```{r}
df4 <- df4 %>% mutate(C = sign((FTHG.x - FTAG.x) - (FTAG.y - FTHG.y))) %>% dplyr::select(SEASON, COUNTRY, LEAGUE, team1, team2, C)
df4 <- df4 %>% group_by(SEASON, COUNTRY, LEAGUE, C) %>% summarise(count=n()) %>% drop_na() %>% spread(key = "C", value = "count")
colnames(df4) <- c("SEASON", "COUNTRY", "LEAGUE", "k_1", "k0", "k1")

ha_c <- df4 %>% mutate(k_1 = ifelse(is.na(k_1), 0, k_1),
                      k0 = ifelse(is.na(k0), 0, k0),
                      k1 = ifelse(is.na(k1), 0, k1)) %>% mutate(ha_c = 1 - pbeta(1/2, k1/(k_1+k0+k_1) + 1, k_1/(k_1+k0+k_1) + 1))

```
```{r}
cb_ha <- ha_c %>% dplyr::select(SEASON, COUNTRY, LEAGUE, ha_c)
```

# Bradley-Terry based Home Team Advantage

```{r}
# f_bt <- data %>% mutate(ht_w = ifelse(FTR == "H", 1,
#                                   ifelse(FTR == "D", 0.5, 0)),
#                              at_w = ifelse(FTR == "A", 1,
#                                   ifelse(FTR == "D", 0.5, 0)))
```

```{r}
# f_bt1 <- f_bt %>%
#   mutate(HOMETEAM = as.factor(HOMETEAM),
#          AWAYTEAM = as.factor(AWAYTEAM)) %>%
#   group_by(HOMETEAM, AWAYTEAM, SEASON)
# 
# f_bt1$HOMETEAM <- data.frame(team = f_bt1$HOMETEAM, at.home = 1)
# f_bt1$AWAYTEAM <- data.frame(team = f_bt1$AWAYTEAM, at.home = 0)

```


```{r}
# f_bt1 <- f_bt1 %>% group_by(SEASON, COUNTRY, LEAGUE)
# f_bt1 <- f_bt1 %>% do(ha = coefficients(BTm(cbind(ht_w, at_w), HOMETEAM, AWAYTEAM, formula = ~team + at.home, data = ., id="team"))["at.home"])
# 
# f_bt2 <- f_bt1
# 
# f_bt1$ha <- flatten_dbl(f_bt1$ha)
# 
# head(f_bt1)
```
```{r}
# f_bt1 <- f_bt1 %>% rename("ha_bt" = "ha")
```

```{r}
# cb_ha <- left_join(cb_ha, f_bt1, by = c("SEASON", "COUNTRY", "LEAGUE"))
# head(cb_ha)
```

# Poisson Model based Home Team Advantage
```{r}
league <- data %>%
  group_by(COUNTRY, SEASON, LEAGUE) %>%
  dplyr::select(SEASON, COUNTRY, LEAGUE, HOMETEAM, AWAYTEAM, FTHG, FTAG)

l1 <- data.frame(league[, c("SEASON","COUNTRY", "LEAGUE", "HOMETEAM", "AWAYTEAM", "FTHG")], Home = 1)
l2 <- data.frame(league[, c("SEASON","COUNTRY", "LEAGUE", "AWAYTEAM", "HOMETEAM", "FTAG")], Home = 0)

colnames(l1) <- c("SEASON","COUNTRY", "LEAGUE", "Team", "Opponent", "Goal", "Home")
colnames(l2) <- c("SEASON","COUNTRY", "LEAGUE", "Team", "Opponent", "Goal", "Home")

l2 <- rbind(l1, l2)
```

```{r}
l2 <- l2 %>% group_by(SEASON, COUNTRY, LEAGUE) %>%
  do(ha_pois = exp(coefficients(glm(Goal ~ Team + Opponent + Home, data = ., family=poisson(link=log)))["Home"]))
l2$ha_pois <- flatten_dbl(l2$ha_pois)
```

```{r}
cb_ha <- left_join(cb_ha, l2, by = c("COUNTRY", "SEASON", "LEAGUE"))
# head(cb_ha)
```

```{r}
# ggplot(cb_ha, aes(ha_pois, ha_bt))+geom_point()+facet_wrap(~COUNTRY, nrow=3)
```

```{r}
# ggplot(cb_ha, aes(ha_pois, ha_c))+geom_point()+facet_wrap(~LEAGUE, nrow=3)
```
```{r}
# ggplot(cb_ha, aes(ha_bt, ha_c))+geom_point()+facet_wrap(~COUNTRY, nrow=3)
```
# Competitive balance

# Entropy

```{r}
f <- f %>% mutate(Wpct = Total_Points/3/Matches, Wpct = Wpct/sum(Wpct))
```

```{r}
H <- f %>% group_by(SEASON, COUNTRY, LEAGUE) %>% summarize(H = -sum(Wpct * log2(Wpct + 10^(-10))), n = n())
H <- H %>% mutate(Hm = -n * 1/n * log2(1/n))
H <- H %>% mutate(cb_entropy = H / Hm) %>% dplyr::select(SEASON, COUNTRY, LEAGUE, cb_entropy)
# H

```
```{r}
cb_ha <- left_join(cb_ha, H, by = c("COUNTRY", "SEASON", "LEAGUE"))
# head(cb_ha)
```

# Surprise Indices

```{r}
data_s <- data %>% 
  left_join(dplyr::select(f, SEASON, COUNTRY, LEAGUE, Team, Position), 
            by = c("SEASON" = "SEASON", "COUNTRY" = "COUNTRY", "LEAGUE" = "LEAGUE", "HOMETEAM" = "Team")) %>%
  rename(HTP = Position)

data_s <- data_s %>% 
  left_join(dplyr::select(f, SEASON, COUNTRY, LEAGUE, Team, Position), 
            by = c("SEASON" = "SEASON", "COUNTRY" = "COUNTRY", "LEAGUE" = "LEAGUE", "AWAYTEAM" = "Team")) %>%
  rename(ATP = Position)


data_s <- data_s %>% mutate(Surprise_Points = ifelse((FTR == 'A' & HTP < ATP) | (FTR == 'H' & HTP > ATP), 2,
                                         ifelse(FTR == 'D' , 1, 0)))

data_s <- data_s %>% mutate(Surprise_Points = Surprise_Points*abs(HTP-ATP))
```

```{r}

sp <- data_s %>% group_by(SEASON, COUNTRY, LEAGUE) %>% summarize(Surprise_Points = sum(Surprise_Points))


sp <- sp %>% left_join(f %>% group_by(SEASON, COUNTRY, LEAGUE) %>% summarise(N = n()))
sp <- sp %>% mutate(M = (N - 1) * N * (N + 1) / 3)

sp <- sp %>% mutate(cb_s = Surprise_Points/M) %>% dplyr::select(SEASON, COUNTRY, LEAGUE, cb_s)

```

```{r}
cb_ha <- left_join(cb_ha, sp, by = c("COUNTRY", "SEASON", "LEAGUE"))
# head(cb_ha)
```

# Gini Competitive Balance
```{r}
Gini <- f %>% group_by(SEASON, COUNTRY, LEAGUE) %>% summarize(cb_gini = gini(Wpct))
# Gini
```

```{r}
cb_ha <- left_join(cb_ha, Gini, by = c("COUNTRY", "SEASON", "LEAGUE"))
# head(cb_ha)
```

```{r}
# ggplot(cb_ha, aes(cb_gini, cb_s))+geom_point()+facet_wrap(~LEAGUE, nrow=3)
```

# Calculating HHI and Noll-Scully

```{r}
adj_HHI <- f %>%
  group_by(SEASON, COUNTRY, LEAGUE) %>%
  mutate(Perc = Wpct / sum(Wpct)) %>%
  summarise(id_s = 0.5/sqrt(n()),  cb_hhi = sum(Perc^2)-1/n(), cb_ns = sd(Perc)/id_s) %>% dplyr::select(-id_s)

```

```{r}
cb_ha <- left_join(cb_ha, adj_HHI, by = c("COUNTRY", "SEASON", "LEAGUE"))
```


```{r include=T, echo=F}

selectInput(
  'ha', label = 'Method for Home Team Advantage',
  choices = grep("^ha", colnames(cb_ha), value=T) , selected = "ha_pois"
)

selectInput(
  'cb', label = 'Method for Competitive Balance',
  choices = grep("^cb", colnames(cb_ha), value=T) , selected = "cb_hhi"
)

renderPlot({
   ggplot(cb_ha, aes_string(input$ha, input$cb))+geom_point()+
    labs(x=input$ha, y=input$cb, title = paste(input$ha, "vs", input$cb, "Scatterplot"))+
    theme_minimal()
})
```



